<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mon profil - Opportunité d'affaires</title>
  <link rel="icon" href="assets/images/logo.png" type="image/png">
  <link rel="stylesheet" href="css/style-modern.css">
  <link rel="stylesheet" href="css/responsive-modern.css">
</head>
<body>

  <!-- Header -->
  <header class="header">
    <div class="container header-inner">
      <a href="index.html" class="logo">
        <img src="assets/images/logo.png" alt="Logo">
        <span>Opportunité d'affaires</span>
      </a>

      <nav class="nav">
        <a href="index.html" class="nav-link">Accueil</a>
        <a href="properties.html" class="nav-link">Annonces</a>
      </nav>

      <div class="nav-actions">
        <div class="user-menu">
          <span class="user-name"></span>
          <button class="btn btn-ghost logout-btn">Déconnexion</button>
        </div>
      </div>

      <button class="menu-toggle">Menu</button>
    </div>
  </header>

  <!-- Main Content -->
  <main style="padding-top: 90px;">
    <div class="container section">

      <!-- Auth Required -->
      <div id="auth-required" class="card" style="max-width: 500px; margin: 0 auto; display: none;">
        <div class="card-body text-center">
          <div style="margin-bottom: 20px;"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--gray)" stroke-width="1.5"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg></div>
          <h2>Connexion requise</h2>
          <p class="text-gray mt-1 mb-2">
            Connectez-vous pour accéder à votre profil.
          </p>
          <a href="login.html?redirect=profile.html" class="btn btn-primary">Se connecter</a>
        </div>
      </div>

      <!-- Profile Content -->
      <div id="profile-content" style="display: none; max-width: 600px; margin: 0 auto;">
        
        <div class="mb-3">
          <h1 class="section-title">Mon profil</h1>
          <p class="section-subtitle">Gérez vos informations personnelles</p>
        </div>

        <!-- Profile Card -->
        <div class="card">
          <div class="card-body">
            
            <!-- Profile Header -->
            <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--gray-light);">
              <div style="width: 80px; height: 80px; border-radius: 50%; background: var(--primary-light); display: flex; align-items: center; justify-content: center;">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
              </div>
              <div>
                <h2 id="profile-name-display" style="margin: 0;">-</h2>
                <span id="profile-role" class="badge badge-primary">-</span>
                <span id="profile-agent-status" class="badge" style="display: none;"></span>
              </div>
            </div>

            <!-- Profile Form -->
            <form id="profile-form">
              <div class="form-group">
                <label class="form-label">Nom complet</label>
                <input type="text" name="name" id="profile-name" class="form-input" required>
              </div>

              <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="profile-email" class="form-input" disabled>
                <small class="text-gray">L'email ne peut pas être modifié</small>
              </div>

              <div class="form-group">
                <label class="form-label">Téléphone</label>
                <input type="tel" name="phone" id="profile-phone" class="form-input" placeholder="+237 6XX XXX XXX">
              </div>

              <div class="form-group">
                <label class="form-label">Société / Agence</label>
                <input type="text" name="company" id="profile-company" class="form-input" placeholder="Nom de votre agence">
              </div>

              <div class="form-group">
                <label class="form-label">Bio</label>
                <textarea name="bio" id="profile-bio" class="form-textarea" rows="3" placeholder="Présentez-vous en quelques mots..."></textarea>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                  <label class="form-label">Ville</label>
                  <input type="text" name="city" id="profile-city" class="form-input" placeholder="Yaoundé">
                </div>
                <div class="form-group">
                  <label class="form-label">Région</label>
                  <select name="region" id="profile-region" class="form-select">
                    <option value="">Sélectionner</option>
                    <option value="Centre">Centre</option>
                    <option value="Littoral">Littoral</option>
                    <option value="Ouest">Ouest</option>
                    <option value="Sud">Sud</option>
                    <option value="Est">Est</option>
                    <option value="Nord">Nord</option>
                    <option value="Adamaoua">Adamaoua</option>
                    <option value="Extrême-Nord">Extrême-Nord</option>
                    <option value="Nord-Ouest">Nord-Ouest</option>
                    <option value="Sud-Ouest">Sud-Ouest</option>
                  </select>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">Adresse</label>
                <input type="text" name="address" id="profile-address" class="form-input" placeholder="Quartier, rue...">
              </div>

              <div class="flex-between" style="margin-top: 30px;">
                <button type="submit" class="btn btn-primary">
                  Enregistrer
                </button>
                <a href="index.html" class="btn btn-ghost">Annuler</a>
              </div>
            </form>

          </div>
        </div>

        <!-- Quick Links -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 30px;">
          <a href="favorites.html" class="card" style="text-decoration: none;">
            <div class="card-body text-center">
              <div style="margin-bottom: 10px;"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5"><path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z"/></svg></div>
              <div style="font-weight: 600;">Mes favoris</div>
            </div>
          </a>
          <a href="my-properties.html" class="card" id="link-my-properties" style="text-decoration: none; display: none;">
            <div class="card-body text-center">
              <div style="margin-bottom: 10px;"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></div>
              <div style="font-weight: 600;">Mes annonces</div>
            </div>
          </a>
          <a href="submit.html" class="card" id="link-submit" style="text-decoration: none; display: none;">
            <div class="card-body text-center">
              <div style="margin-bottom: 10px;"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg></div>
              <div style="font-weight: 600;">Publier</div>
            </div>
          </a>
        </div>

      </div>

    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-bottom">
        <p class="footer-copyright">© 2024 Opportunité d'affaires. Tous droits réservés.</p>
      </div>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="js/app.js"></script>
  <script src="js/auth.js"></script>
  <script>
    const roleLabels = {
      'admin_central': 'Administrateur',
      'agent_regional': 'Agent immobilier',
      'client_acheteur': 'Acheteur',
      'client_vendeur': 'Vendeur'
    };

    const agentStatusLabels = {
      'pending': 'En attente de validation',
      'approved': 'Validé',
      'rejected': 'Refusé'
    };

    document.addEventListener('DOMContentLoaded', () => {
      if (App.isLoggedIn()) {
        document.getElementById('auth-required').style.display = 'none';
        document.getElementById('profile-content').style.display = 'block';
        loadProfile();
      } else {
        document.getElementById('auth-required').style.display = 'block';
        document.getElementById('profile-content').style.display = 'none';
      }
    });

    async function loadProfile() {
      // Charger le profil complet depuis l'API
      try {
        const data = await apiRequest('/profile');
        const user = data.user || App.user;
        
        // Afficher les infos
        document.getElementById('profile-name-display').textContent = user.name || '-';
        document.getElementById('profile-name').value = user.name || '';
        document.getElementById('profile-email').value = user.email || '';
        document.getElementById('profile-phone').value = user.phone || '';
        document.getElementById('profile-company').value = user.company || '';
        document.getElementById('profile-bio').value = user.bio || '';
        document.getElementById('profile-city').value = user.city || '';
        document.getElementById('profile-region').value = user.region || '';
        document.getElementById('profile-address').value = user.address || '';
        document.getElementById('profile-role').textContent = roleLabels[user.role] || user.role;

        // Statut agent
        if (user.role === 'agent_regional' && user.agentStatus) {
          const statusEl = document.getElementById('profile-agent-status');
          statusEl.style.display = 'inline-block';
          statusEl.textContent = agentStatusLabels[user.agentStatus] || user.agentStatus;
          statusEl.className = `badge badge-${user.agentStatus === 'approved' ? 'success' : user.agentStatus === 'rejected' ? 'error' : 'warning'}`;
        }

        // Liens rapides selon le rôle
        if (['agent_regional', 'client_vendeur', 'admin_central'].includes(user.role)) {
          document.getElementById('link-my-properties').style.display = 'block';
          document.getElementById('link-submit').style.display = 'block';
        }
      } catch (error) {
        console.error('Erreur chargement profil:', error);
      }

      // Formulaire
      document.getElementById('profile-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Enregistrement...';

        try {
          const updated = await apiRequest('/profile', {
            method: 'PATCH',
            body: JSON.stringify({
              name: document.getElementById('profile-name').value,
              phone: document.getElementById('profile-phone').value,
              company: document.getElementById('profile-company').value,
              bio: document.getElementById('profile-bio').value,
              city: document.getElementById('profile-city').value,
              region: document.getElementById('profile-region').value,
              address: document.getElementById('profile-address').value
            })
          });
          
          // Mettre à jour le localStorage
          if (updated.user) {
            localStorage.setItem('user', JSON.stringify(updated.user));
            App.user = updated.user;
          }
          
          document.getElementById('profile-name-display').textContent = document.getElementById('profile-name').value;
          showNotification('Profil mis à jour', 'success');
        } catch (error) {
          showNotification(error.message, 'error');
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Enregistrer';
        }
      });
    }
  </script>

</body>
</html>
