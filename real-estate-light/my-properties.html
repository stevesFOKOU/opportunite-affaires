<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mes annonces - Opportunit√© d'affaires</title>
  <link rel="icon" href="assets/images/logo.png" type="image/png">
  <link rel="stylesheet" href="css/style-modern.css">
  <link rel="stylesheet" href="css/responsive-modern.css">
</head>
<body>

  <!-- Header -->
  <header class="header">
    <div class="container header-inner">
      <a href="index.html" class="logo">
        <img src="assets/images/logo.png" alt="Logo">
        <span>Opportunit√© d'affaires</span>
      </a>

      <nav class="nav">
        <a href="index.html" class="nav-link">Accueil</a>
        <a href="properties.html" class="nav-link">Annonces</a>
        <a href="my-properties.html" class="nav-link">Mes annonces</a>
        <a href="submit.html" class="nav-link">Publier</a>
      </nav>

      <div class="nav-actions">
        <div class="user-menu">
          <span class="user-name"></span>
          <button class="btn btn-ghost logout-btn">D√©connexion</button>
        </div>
      </div>

      <button class="menu-toggle">‚ò∞</button>
    </div>
  </header>

  <!-- Main Content -->
  <main style="padding-top: 90px;">
    <div class="container section">

      <!-- Auth Required -->
      <div id="auth-required" class="card" style="max-width: 500px; margin: 0 auto; display: none;">
        <div class="card-body text-center">
          <div style="font-size: 4rem; margin-bottom: 20px;">üîí</div>
          <h2>Connexion requise</h2>
          <p class="text-gray mt-1 mb-2">
            Connectez-vous pour voir vos annonces.
          </p>
          <a href="login.html?redirect=my-properties.html" class="btn btn-primary">Se connecter</a>
        </div>
      </div>

      <!-- My Properties Dashboard -->
      <div id="my-properties-dashboard" style="display: none;">
        
        <div class="flex-between mb-3" style="flex-wrap: wrap; gap: 20px;">
          <div>
            <h1 class="section-title">Mes annonces</h1>
            <p class="section-subtitle">G√©rez vos biens immobiliers</p>
          </div>
          <a href="submit.html" class="btn btn-primary">
            ‚ûï Publier une annonce
          </a>
        </div>

        <!-- Stats -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-bottom: 40px;">
          <div class="card">
            <div class="card-body text-center">
              <div style="font-size: 2rem; font-weight: 700; color: var(--primary);" id="stat-total">0</div>
              <div class="text-gray">Total</div>
            </div>
          </div>
          <div class="card">
            <div class="card-body text-center">
              <div style="font-size: 2rem; font-weight: 700; color: var(--success);" id="stat-published">0</div>
              <div class="text-gray">Publi√©es</div>
            </div>
          </div>
          <div class="card">
            <div class="card-body text-center">
              <div style="font-size: 2rem; font-weight: 700; color: var(--warning);" id="stat-draft">0</div>
              <div class="text-gray">En attente</div>
            </div>
          </div>
        </div>

        <!-- Properties Grid -->
        <div id="my-properties-grid" class="properties-grid">
          <div class="flex-center" style="grid-column: 1/-1; padding: 60px;">
            <div class="spinner"></div>
          </div>
        </div>

      </div>

    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-bottom">
        <p class="footer-copyright">¬© 2024 Opportunit√© d'affaires. Tous droits r√©serv√©s.</p>
      </div>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="js/app.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/properties.js"></script>
  <script>
    // V√©rifier l'authentification
    document.addEventListener('DOMContentLoaded', () => {
      if (App.isLoggedIn()) {
        document.getElementById('auth-required').style.display = 'none';
        document.getElementById('my-properties-dashboard').style.display = 'block';
        loadMyPropertiesPage();
      } else {
        document.getElementById('auth-required').style.display = 'block';
        document.getElementById('my-properties-dashboard').style.display = 'none';
      }
    });

    // Charger mes annonces
    async function loadMyPropertiesPage() {
      const container = document.getElementById('my-properties-grid');

      try {
        const data = await apiRequest('/properties?mine=true');
        const properties = data.properties || data || [];

        // Stats
        document.getElementById('stat-total').textContent = properties.length;
        document.getElementById('stat-published').textContent = properties.filter(p => p.status === 'published').length;
        document.getElementById('stat-draft').textContent = properties.filter(p => p.status === 'draft').length;

        if (properties.length === 0) {
          container.innerHTML = `
            <div class="empty-state" style="grid-column: 1/-1;">
              <div class="empty-state-icon">üè†</div>
              <div class="empty-state-title">Aucune annonce</div>
              <div class="empty-state-text">Vous n'avez pas encore publi√© d'annonce.</div>
              <a href="submit.html" class="btn btn-primary mt-2">Publier ma premi√®re annonce</a>
            </div>
          `;
          return;
        }

        container.innerHTML = properties.map(p => createMyPropertyCard(p)).join('');

      } catch (error) {
        container.innerHTML = `
          <div class="alert alert-error" style="grid-column: 1/-1;">
            Erreur lors du chargement de vos annonces
          </div>
        `;
      }
    }

    // Cr√©er une carte pour mes annonces (avec statut et actions)
    function createMyPropertyCard(property) {
      const imageUrl = property.photos?.[0]?.url 
        ? getImageUrl(property.photos[0].url) 
        : 'assets/images/placeholder.jpg';

      const statusBadge = property.status === 'published' 
        ? '<span class="badge badge-success">Publi√©e</span>'
        : '<span class="badge badge-warning">En attente</span>';

      return `
        <article class="card">
          <div class="card-image">
            <img src="${imageUrl}" alt="${property.title}" loading="lazy">
            <span class="card-badge">${translatePropertyType(property.type)}</span>
          </div>
          <div class="card-body">
            <div class="flex-between mb-1">
              <h3 class="card-title" style="margin: 0;">${property.title}</h3>
              ${statusBadge}
            </div>
            <div class="card-location">
              <span>üìç</span>
              <span>${property.city || ''}${property.city && property.region ? ', ' : ''}${property.region || ''}</span>
            </div>
            <div class="card-features">
              ${property.surfaceM2 ? `<span class="card-feature">üìê ${property.surfaceM2} m¬≤</span>` : ''}
            </div>
            <div class="card-footer">
              <div class="card-price">${formatPrice(property.price, property.currency)}</div>
              <a href="property-detail.html?id=${property.id}" class="btn btn-sm btn-outline">Voir</a>
            </div>
            <div class="text-gray mt-1" style="font-size: 0.75rem;">
              Cr√©√©e le ${formatDate(property.createdAt)}
            </div>
          </div>
        </article>
      `;
    }
  </script>

</body>
</html>
