<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mes favoris - Opportunité d'affaires</title>
  <link rel="icon" href="assets/images/logo.png" type="image/png">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/responsive.css">
</head>
<body>

  <!-- Header -->
  <header class="header">
    <div class="container header-inner">
      <a href="index.html" class="logo">
        <img src="assets/images/logo.png" alt="Logo">
        <span>Opportunité d'affaires</span>
      </a>

      <nav class="nav">
        <a href="index.html" class="nav-link">Accueil</a>
        <a href="properties.html" class="nav-link">Annonces</a>
        <a href="favorites.html" class="nav-link active">Favoris</a>
      </nav>

      <div class="nav-actions">
        <div class="auth-buttons">
          <a href="login.html" class="btn btn-ghost">Connexion</a>
        </div>
        <div class="user-menu" style="display: none;">
          <span class="user-name"></span>
          <button class="btn btn-ghost logout-btn">Déconnexion</button>
        </div>
      </div>

      <button class="menu-toggle">Menu</button>
    </div>
  </header>

  <!-- Main Content -->
  <main style="padding-top: 90px;">
    <div class="container section">

      <!-- Auth Required -->
      <div id="auth-required" class="card" style="max-width: 500px; margin: 0 auto; display: none;">
        <div class="card-body text-center">
          <div style="margin-bottom: 20px;"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--gray)" stroke-width="1.5"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg></div>
          <h2>Connexion requise</h2>
          <p class="text-gray mt-1 mb-2">
            Connectez-vous pour voir vos favoris.
          </p>
          <a href="login.html?redirect=favorites.html" class="btn btn-primary">Se connecter</a>
        </div>
      </div>

      <!-- Favorites Content -->
      <div id="favorites-content" style="display: none;">
        <div class="mb-3">
          <h1 class="section-title">Mes favoris</h1>
          <p class="section-subtitle">Les biens que vous avez sauvegardés</p>
        </div>

        <!-- Favorites Grid -->
        <div id="favorites-grid" class="properties-grid">
          <div class="flex-center" style="grid-column: 1/-1; padding: 60px;">
            <div class="spinner"></div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-bottom">
        <p class="footer-copyright">© 2024 Opportunité d'affaires. Tous droits réservés.</p>
      </div>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="js/app.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/properties.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (App.isLoggedIn()) {
        document.getElementById('auth-required').style.display = 'none';
        document.getElementById('favorites-content').style.display = 'block';
        loadFavoritesPage();
      } else {
        document.getElementById('auth-required').style.display = 'block';
        document.getElementById('favorites-content').style.display = 'none';
      }
    });

    async function loadFavoritesPage() {
      const container = document.getElementById('favorites-grid');

      try {
        const data = await apiRequest('/favorites');
        const favorites = data.favorites || data || [];

        if (favorites.length === 0) {
          container.innerHTML = `
            <div class="empty-state" style="grid-column: 1/-1;">
              <div class="empty-state-icon"><svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--gray)" stroke-width="1.5"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg></div>
              <div class="empty-state-title">Aucun favori</div>
              <div class="empty-state-text">Vous n'avez pas encore ajouté de biens à vos favoris.</div>
              <a href="properties.html" class="btn btn-primary mt-2">Parcourir les annonces</a>
            </div>
          `;
          return;
        }

        container.innerHTML = favorites.map(fav => {
          const p = fav.property;
          if (!p) return '';
          
          const imageUrl = p.photos?.[0]?.url 
            ? getImageUrl(p.photos[0].url) 
            : 'assets/images/placeholder.jpg';

          return `
            <article class="card">
              <div class="card-image">
                <img src="${imageUrl}" alt="${p.title}" loading="lazy">
                <span class="card-badge">${translatePropertyType(p.type)}</span>
                <button class="card-favorite active" onclick="removeFavorite('${p.id}', this)" title="Retirer des favoris">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="var(--error)" stroke="var(--error)" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>
                </button>
              </div>
              <div class="card-body">
                <h3 class="card-title">${p.title}</h3>
                <div class="card-location">
                  <span></span>
                  <span>${p.city || ''}${p.city && p.region ? ', ' : ''}${p.region || ''}</span>
                </div>
                <div class="card-features">
                  ${p.surfaceM2 ? `<span class="card-feature">${p.surfaceM2} m²</span>` : ''}
                </div>
                <div class="card-footer">
                  <div class="card-price">${formatPrice(p.price, p.currency)}</div>
                  <a href="property-detail.html?id=${p.id}" class="btn btn-sm btn-outline">Voir</a>
                </div>
              </div>
            </article>
          `;
        }).join('');

      } catch (error) {
        console.error('Erreur favoris:', error);
        if (error.message.includes('401') || error.message.includes('token') || error.message.includes('authentification')) {
          // Token expiré - déconnecter et rediriger
          localStorage.removeItem('token');
          localStorage.removeItem('user');
          window.location.href = 'login.html?redirect=favorites.html';
        } else {
          container.innerHTML = `
            <div class="alert alert-error" style="grid-column: 1/-1;">
              Erreur lors du chargement des favoris: ${error.message}
            </div>
          `;
        }
      }
    }

    async function removeFavorite(propertyId, btn) {
      try {
        await apiRequest(`/favorites/${propertyId}`, { method: 'DELETE' });
        showNotification('Retiré des favoris', 'success');
        btn.closest('.card').remove();
        
        // Vérifier s'il reste des favoris
        const grid = document.getElementById('favorites-grid');
        if (grid.querySelectorAll('.card').length === 0) {
          loadFavoritesPage();
        }
      } catch (error) {
        showNotification(error.message, 'error');
      }
    }
  </script>

</body>
</html>
